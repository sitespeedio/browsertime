language: node_js
os:
  - linux
  - osx
osx_image: xcode11.3
node_js:
  - '12'
sudo: required
dist: bionic
cache:
  apt: true
  pip: true
  directories:
    - '$HOME/.npm'
    - $HOME/.local/lib/python2.7/site-packages
    - /usr/local/lib/python2.7/site-packages
addons:
  apt:
    sources:
      - sourceline: 'ppa:ubuntu-toolchain-r/test'
    packages:
      - python3
      - python3-pip
      - imagemagick
      - ipython
      - libjpeg-dev
      - python
      - python-dev
      - python-pil
      - python-numpy
      - python-scipy
      - python-matplotlib
      - python-pandas
      - python-pip
      - python-sympy
      - python-nose
      - xz-utils
      - ttf-ubuntu-font-family
  firefox: 'latest'
  chrome: stable
before_install:
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then ./.travis.before_install-osx.sh; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo snap install ffmpeg; fi
  - python -m pip install --upgrade --user pip
  - python -m pip install --upgrade --user setuptools
  - python -m pip install --user pyssim
  - python -m pip --version
  - python -m pip show Pillow
  - python -m pip show pyssim
  - ffmpeg -version
  - python --version
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then firefox --version 2>/dev/null; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then google-chrome --product-version; fi
before_script:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then export DISPLAY=:99.0;fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then /sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -ac -screen 0 1600x1024x16;fi
  - ./browsertime/visualmetrics.py --check
install:
  - npm ci
script:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then VTENV_OPTS="-p python3" make test; fi
  - npm run eslint-check && npm run lint
  - node ./bin/browsertime.js -b firefox -n 1 https://www.sitespeed.io --connectivity.profile cable --connectivity.engine throttle
  - node ./bin/browsertime.js -b chrome --skipHar -n 1 --preURL https://www.sitespeed.io/ -r header:value --chrome.CPUThrottlingRate 2 --chrome.cdp.performance --chrome.enableChromeDriverLog https://www.sitespeed.io/documentation/
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then node ./bin/browsertime.js -b chrome -vv --viewPort=640x480 --video --screenshot --connectivity.engine tsproxy -c cable --visualMetrics -n 1 --chrome.timeline --videoParams.fontPath /usr/share/fonts/truetype/ubuntu-font-family/Ubuntu-R.ttf --visualElements --chrome.collectLongTasks --cookie test=true https://www.sitespeed.io/; fi
  - node ./bin/browsertime.js -b chrome test/navigationscript/measure.js -n 1 --preScript test/prepostscripts/preSample.js --postScript test/prepostscripts/postSample.js
  - node ./bin/browsertime.js -b chrome test/navigationscript/navigateAndStartInTwoSteps.js -n 1 --pageCompleteCheckInactivity --timeToSettle 1000
  - node ./bin/browsertime.js -b firefox test/navigationscript/multi.js https://www.sitespeed.io/blog/ -n 1
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then node ./bin/browsertime.js -b chrome test/navigationscript/multi.js -n 3 --chrome.timeline --video --visualMetrics --videoParams.fontPath /usr/share/fonts/truetype/ubuntu-font-family/Ubuntu-R.ttf --visualElements; fi
  - node ./bin/browsertime.js -b firefox --firefox.geckoProfiler -n 1 https://www.sitespeed.io/ --spa
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then node ./bin/browsertime.js -b edge -n 1 --edge.edgedriverPath ./msedgedriver https://www.sitespeed.io/ ; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then node ./bin/browsertime.js -b safari -n 1 https://www.sitespeed.io/ ;fi
  - npm run test
notifications:
  slack:
    secure: V71EkIzwOf/fZnGTGIKAIFlDyLUit4tK97VDgdV9vZ7CbvOXI1ir3lwRZ57lNqiYD8BUaX+/wKDG+LyrBMgQ4JAGgQx0mECvmOKx1+10Yg9FAkUsMTWe7GOxcVMwhpS2OfHnXwMb0FjcuVl8ovowIZqCWOLeEAYVaTWHndDm2cA=
    